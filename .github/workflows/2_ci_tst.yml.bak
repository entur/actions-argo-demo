name: "Test release"
on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*-*"
env:
  ENV: "tst"
  VERSION: "${{github.ref_name}}"  # version from tag
  CARGO_TERM_COLOR: always
  PROJECT_ID: ent-getstarted-sbx
  DOCKER_URL: europe-west1-docker.pkg.dev
  WORKLOAD_IDENTITY_PROVIDER: "projects/475080371789/locations/global/workloadIdentityPools/poc-gh-actions-pool/providers/poc-gh-actions-provider"
  SERVICE_ACCOUNT: "github-actions-poc@ent-getstarted-sbx.iam.gserviceaccount.com"
  IMAGE_PATH: "ent-getstarted-sbx/getting-started-github-actions/hello-github-actions"

jobs:
  update-image-tag:
    name: "Update Image Test"
    permissions:
      contents: 'write'
      id-token: 'none'
      actions: none
      checks: none
      deployments: none
      issues: none
      discussions: none
      packages: none
      pages: none
      pull-requests: none
      repository-projects: none
      security-events: none
      statuses: none
    runs-on: "ubuntu-latest"
    environment: "tst"
    steps:
      - name: "Git checkout"
        uses: "actions/checkout@v2"
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}
      - uses: yokawasa/action-setup-kube-tools@v0.9.2
        with:
          setup-tools: |
            kustomize
          kustomize: '5.2.1'
      - name: "Update Deployment Image Tag"
        working-directory: ".argo/hestekur/overlays/${{ env.ENV }}"
        run: |
          kustomize edit set image app-image=${{env.DOCKER_URL}}/${{env.IMAGE_PATH}}:${{ env.VERSION }}
      - name: Commit kustomization and tag version
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          branch: main
          commit_message: "ci: Update deployment image tag in ${{ env.ENV }} to ${{ env.VERSION }} [skip ci]"
          tagging_message: "${{ env.VERSION }}"
          file_pattern: .argo/*/overlays/${{env.ENV}}/kustomization.yaml
      # create release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.VERSION }}
          release_name: Release ${{ env.VERSION }}
          draft: false
          prerelease: false